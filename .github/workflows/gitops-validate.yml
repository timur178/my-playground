name: Gitops Validate and Render
on:
  workflow_dispatch: {}
  push:
    branches: [ feature/kafka-dev ]
    paths:
      - "kafka-gitops/**"
      - ".github/workflows/gitops-validate.yml"

env:
  GITOPS_REPO_URL: ${{ vars.GITOPS_REPO_URL }}
  GITOPS_TARGET_REVISION: ${{ vars.GITOPS_TARGET_REVISION }}
  AWS_REGION:        ${{ vars.AWS_REGION }}
  ESO_IRSA_ROLE_ARN: ${{ vars.ESO_IRSA_ROLE_ARN }}
  RDS_SECRET_NAME:   ${{ vars.RDS_SECRET_NAME }}
  ACM_CERT_ARN:      ${{ vars.ACM_CERT_ARN }}

  # include ONLY if you install EBS CSI via Helm (not needed for EKS add-on)
  # EBS_CSI_IRSA_ROLE_ARN: ${{ vars.EBS_CSI_IRSA_ROLE_ARN }}

  # include ONLY if you also render values files that use these in hosts, etc.
  # TEAM:              ${{ vars.TEAM }}
  # TEAM_DOMAIN:       ${{ vars.TEAM_DOMAIN }}
  # ENVIRONMENT_STAGE: ${{ vars.ENVIRONMENT_STAGE }}

jobs:
  render:
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Render to kafka-gitops/rendered/dev
        run: |
          set -euo pipefail
          rm -rf kafka-gitops/rendered/dev
          mkdir -p kafka-gitops/rendered/dev

          # copy only *.yaml while preserving dirs, exclude any existing rendered/
          rsync -a --prune-empty-dirs \
            --include '*/' --include '*.yaml' --exclude '*' \
            --exclude 'rendered/' \
            kafka-gitops/ kafka-gitops/rendered/dev/

          # envsubst all yaml files in place
          while IFS= read -r -d '' f; do
            tmp="${f}.tmp"
            envsubst < "$f" > "$tmp" && mv "$tmp" "$f"
          done < <(find kafka-gitops/rendered/dev -type f -name '*.yaml' -print0)

      - name: Fail if any ${VARS} remain after render
        run: |
          LEFT=$(grep -R '\${[A-Za-z_][A-Za-z0-9_]*}' kafka-gitops/rendered/dev || true)
          test -z "$LEFT" || { echo "Unresolved placeholders:"; echo "$LEFT"; exit 1; }


      - name: Validate manifests (kubeconform)
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz | tar xz
          ./kubeconform -summary -ignore-missing-schemas -strict kafka-gitops/rendered/dev

      - name: Commit rendered
        run: |
          git add kafka-gitops/rendered/dev || true
          git config user.name ci-bot
          git config user.email ci@example.com
          git commit -m "ci: render gitops for dev" || echo "no changes"
          git push || true
